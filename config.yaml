# =============================================================================
# EigenPSF-DPS: Non-blind Spatially Varying Deconvolution Configuration
# =============================================================================
# This configuration file defines all hyperparameters for the EigenPSF-DPS
# algorithm, which uses diffusion posterior sampling with PCA-decomposed
# spatially varying blur operators.

# -----------------------------------------------------------------------------
# Data Configuration
# -----------------------------------------------------------------------------
data:
  img_size: 256                    # Image resolution (H x W)
  subset_size: 1                   # Number of images to process (demo mode)
  channels: 3                      # Number of image channels (RGB)
  image_source: "sample"           # "sample" (built-in), "url", or path to image

# -----------------------------------------------------------------------------
# Diffusion Model Configuration
# -----------------------------------------------------------------------------
model:
  model_id: "google/ddpm-celebahq-256"  # HuggingFace model identifier
  device: "cuda"                         # Device: "cuda" or "cpu"
  dtype: "float32"                       # Precision: "float32" or "float16"

# -----------------------------------------------------------------------------
# Physics / Blur Simulation Configuration
# -----------------------------------------------------------------------------
physics:
  # Blur mode:
  #   "motion"     - Smoothly varying motion blur (direction changes gradually)
  #   "defocus"    - Smoothly varying defocus (radius increases from center)
  #   "mixed"      - Alternating motion and defocus patterns
  #   "random_iid" - Near-IID random PSFs (drastically different between neighbors)
  #   "correlated" - Spatially correlated asymmetric Gaussians (realistic aberrations)
  blur_mode: "motion"

  # Spatially varying blur parameters
  kernel_size: 21                  # Size of each local PSF kernel
  grid_size: 8                     # Number of PSF samples along each axis (8x8 grid)

  # Motion blur specific parameters
  motion:
    min_length: 5                  # Minimum motion blur length (pixels)
    max_length: 25                 # Maximum motion blur length (pixels)
    angle_variation: 180           # Angle variation range (degrees)

  # Defocus blur specific parameters
  defocus:
    min_radius: 2                  # Minimum defocus radius (pixels)
    max_radius: 12                 # Maximum defocus radius (pixels)

  # Random IID blur specific parameters (near-pixel-level PSF variation)
  random_iid:
    grid_size: 64                  # Dense grid for IID-like variation (64x64)

  # Correlated Gaussian blur parameters (realistic optical aberrations)
  correlated:
    sigma_scale: 0.2               # Scale factor for Gaussian widths (larger = wider PSFs)
    mu_scale: 0.0                  # Scale factor for center offsets (0 = centered PSFs)
    correlation_length: 7          # Spatial correlation length (larger = smoother variation)
    grid_size: 8                   # Grid size (can match image size for smooth fields)

  # EigenPSF decomposition parameters
  n_eigen_psfs: 5                  # Number of PCA components (K) - use 15+ for random_iid

  # Measurement noise
  sigma_noise: 0.01                # Gaussian noise standard deviation

# -----------------------------------------------------------------------------
# DPS (Diffusion Posterior Sampling) Configuration
# -----------------------------------------------------------------------------
dps:
  # Guidance parameters
  step_size: 0.5                   # Gradient scale (zeta) for likelihood guidance
  step_size_schedule: "constant"   # "constant", "linear_decay", or "sqrt_decay"

  # Sampling parameters
  num_inference_steps: 1000        # Total diffusion steps
  skip_steps: 0                    # Steps to skip (0 = use all steps)

  # Gradient clipping for stability
  gradient_clip: 0.0               # Max gradient norm (0 = no clipping)

  # Whether to use gradient checkpointing (saves memory)
  gradient_checkpointing: false

# -----------------------------------------------------------------------------
# Output Configuration
# -----------------------------------------------------------------------------
output:
  save_dir: "./results"            # Output directory
  save_intermediate: true          # Save intermediate reconstructions
  intermediate_freq: 100           # Save every N steps
  save_format: "png"               # Image format: "png" or "jpg"

# -----------------------------------------------------------------------------
# Logging Configuration
# -----------------------------------------------------------------------------
logging:
  level: "INFO"                    # Logging level
  progress_bar: true               # Show tqdm progress bar

# -----------------------------------------------------------------------------
# Reproducibility
# -----------------------------------------------------------------------------
seed: 42                           # Random seed for reproducibility
